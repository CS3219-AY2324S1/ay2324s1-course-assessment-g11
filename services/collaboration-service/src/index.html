<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Code Collaboration Room</title>
  </head>
  <body>
    <h1>Text Collaboration Room</h1>

    <textarea id="textEditor" rows="10" cols="50"></textarea>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const params = new URL(document.location).searchParams;
      const room = params.get("room") ?? 1;
      const user = params.get("user") ?? "user";
      const api = params.get("api") ?? "socket";

      const socket = io("http://localhost:5001/");

      if (api === "get") {
        joinRoomByGetApi(room, user);
      } else {
        joinRoomBySocket(socket);
      }

      /** Using GET API -- not recommended **/
      // Sets the server connection to accept the next incoming connection to room 1.
      // Fine as long as all calls to GET API proceeds with immediate socket connection.
      function joinRoomByGetApi(room, user) {
        var apiUrl = `http://localhost:5001/room/join/${room}?user_id=${user}`;

        fetch(apiUrl)
          .then((response) => {
            return response.json();
          })
          .then((data) => {
            // Work with JSON data here
            console.log(data);
          })
          .catch((err) => {
            // Do something for an error here
            console.error("Error:", err);
          });
      }

      /** Recommended: Using Socket.io EventEmitters as API **/
      function joinRoomBySocket(socket) {
        socket.emit("/room/join", room);
      }
      const textEditor = document.getElementById("textEditor");

      window.onload = () => {
        socket.on("/room/update", ({ text }) => {
          textEditor.value = text;
          console.log("/room/update");
        });

        textEditor.addEventListener("change", () => {
          const text = textEditor.value;
          console.log(text);
          socket.emit("/room/update", text);
        });
      };
    </script>
  </body>
</html>
